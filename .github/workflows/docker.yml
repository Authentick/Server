name: Publish Docker images

on:
  push:
    branches:
      - main
    paths:
      - '.devcontainer/Dockerfile'
      - '.github/workflows/docker.yml'

  build-dev:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
  
    - name: Push to Github Container Registry
      run: |
          cd .devcontainer/
          echo  ${{ secrets.CR_PAT }} | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin
          docker pull ghcr.io/lukasreschke/authserver-dev:latest
          docker build . --tag ghcr.io/lukasreschke/authserver-dev:$GITHUB_SHA --cache-from ghcr.io/lukasreschke/authserver-dev:latest
          docker push ghcr.io/lukasreschke/authserver-dev:${GITHUB_SHA}

